<!DOCTYPE html>
    <html lang="es">
    <head>
        <meta charset="UTF-8">
        <title>An√°lisis de v√≠deo</title>
        <style>
            body { font-family: Arial, sans-serif; margin: 40px; }
            .container { max-width: 900px; }
            input, button { padding: 10px; margin: 5px; }
            input[type="url"] { width: 500px; }
            input[type="range"] { width: 200px; }
            label { display: block; margin: 10px 0 5px 0; font-weight: bold; }
            #videoStream { border: 2px solid #ddd; margin-top: 20px; max-width: 100%; }
            .error { color: red; background: #ffe6e6; padding: 10px; margin: 10px 0; border-radius: 5px; }
            .controls { background: #f0f8ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
            .status { background: #e8f5e8; padding: 10px; border-radius: 5px; margin: 10px 0; }
        </style>
    </head>
    <body>
        <div class="container">
            <div id="infoProyecto" class="status" style="background:#e0eaff; margin-bottom:20px;"></div>
            <h1>üé• An√°lisis de Video</h1>
            
            <div class="controls">
                <input type="url" id="videoUrl" placeholder="https://www.instagram.com/dulceida/reel/C2pBKGKiDSR/" 
                       value="https://www.instagram.com/dulceida/reel/C2pBKGKiDSR/">
                <br><br>
                
                <label for="fpsSlider">üéûÔ∏è FPS del Streaming: <span id="fpsValue">15</span></label>
                <input type="range" id="fpsSlider" min="1" max="60" value="15" oninput="updateFPS()">
                
                <label for="escalaSlider">üîç Factor de Escala: <span id="escalaValue">0.6</span></label>
                <input type="range" id="escalaSlider" min="0.1" max="1.0" step="0.1" value="0.6" oninput="updateEscala()">
                
                <br>
                <label for="deleteAfter">üóëÔ∏è <input type="checkbox" id="deleteAfter" checked> Eliminar video autom√°ticamente despu√©s del procesamiento</label>
                
                <br><br>
                <button onclick="prepareVideo()">Preparar v√≠deo</button>
                <button onclick="startStream()" id="streamBtn" disabled>Iniciar an√°lisis</button>
                <button onclick="stopStream()">Detener</button>
            </div>
            
            <div id="status" class="status"></div>
            <div id="error" class="error" style="display:none;"></div>
            
            <img id="videoStream" style="display:none;" alt="V√≠deo an√°lisis">
        </div>

    <script>
            const serverUrl = import.meta.env.VITE_API_BASE_URL || "http://localhost:8000";
            let prepared = false;

            // Recuperar y mostrar la informaci√≥n del proyecto
            async function cargarInfoProyecto() {
                try {
                    const resp = await fetch(`${serverUrl}/`);
                    if (resp.ok) {
                        const data = await resp.json();
                        document.getElementById('infoProyecto').innerHTML = `
                            <strong>${data.titulo}</strong><br>
                            <b>Equipo:</b> ${data.equipo}<br>
                            <b>Version:</b> ${data.version}<br>
                            <span>${data.descripcion}</span>
                        `;
                    } else {
                        document.getElementById('infoProyecto').innerHTML = 'No se pudo recuperar la informaci√≥n del proyecto.';
                    }
                } catch (e) {
                    document.getElementById('infoProyecto').innerHTML = 'Error de conexi√≥n con la API.' + e;
                }
            }

            window.onload = cargarInfoProyecto;
            
            function updateFPS() {
                const fps = document.getElementById('fpsSlider').value;
                document.getElementById('fpsValue').textContent = fps;
            }
            
            function updateEscala() {
                const escala = document.getElementById('escalaSlider').value;
                document.getElementById('escalaValue').textContent = escala;
            }
            
            async function prepareVideo() {
                const videoUrl = document.getElementById('videoUrl').value;
                const fps = parseFloat(document.getElementById('fpsSlider').value);
                const escala = parseFloat(document.getElementById('escalaSlider').value);
                const deleteAfter = document.getElementById('deleteAfter').checked;
                const status = document.getElementById('status');
                const error = document.getElementById('error');
                
                if (!videoUrl) {
                    showError('Ingresa una URL v√°lida');
                    return;
                }
                
                try {
                    status.innerHTML = '‚è≥ Preparando video...';
                    error.style.display = 'none';
                    
                    const response = await fetch(`${serverUrl}/prepare-video`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            url: videoUrl, 
                            scale_factor: escala, 
                            fps_limit: fps,
                            delay_frames: 1.0 / fps,
                            delete_after_processing: deleteAfter
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        const deleteMsg = deleteAfter ? '<br>üóëÔ∏è Video se eliminar√° autom√°ticamente' : '<br>üíæ Video se conservar√°';
                        status.innerHTML = `‚úÖ V√≠deo preparado: ${data.message}<br>üéûÔ∏è FPS configurado: ${fps}<br>üîç Escala: ${escala}${deleteMsg}`;
                        prepared = true;
                        document.getElementById('streamBtn').disabled = false;
                        document.getElementById('streamBtn').disabled = false;
                        prepared = true;
                    } else {
                        const errorData = await response.json();
                        throw new Error(errorData.detail || 'Error preparando v√≠deo');
                    }
                } catch (err) {
                    showError(err.message);
                    status.innerHTML = '';
                }
            }
            
            function startStream() {
                if (!prepared) {
                    showError('Primero prepara el v√≠deo');
                    return;
                }
                
                const img = document.getElementById('videoStream');
                const timestamp = new Date().getTime();
                img.src = `${serverUrl}/stream?t=${timestamp}`;
                img.style.display = 'block';
                
                const fps = document.getElementById('fpsSlider').value;
                document.getElementById('status').innerHTML = `üé¨ An√°lisis iniciado a ${fps} FPS`;
            }
            
            function stopStream() {
                const img = document.getElementById('videoStream');
                img.src = '';
                img.style.display = 'none';
                document.getElementById('status').innerHTML = '‚èπÔ∏è An√°lisis detenido';
            }
            
            function showError(message) {
                const error = document.getElementById('error');
                error.innerHTML = '‚ùå ' + message;
                error.style.display = 'block';
            }
        </script>
    </body>
    </html>